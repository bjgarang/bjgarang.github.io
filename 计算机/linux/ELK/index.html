



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.1, mkdocs-material-3.0.3">
    
    
      
        <title>ELK+filebeat+kafka日志分析系统</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.451f80e5.css">
      
      
    
    
      <script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../../../#_1" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="My Docs" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                My Docs
              </span>
              <span class="md-header-nav__topic">
                ELK+filebeat+kafka日志分析系统
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../.." title="My Docs" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    My Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="首页" class="md-nav__link">
      首页
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      生活
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        生活
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../生活/life/" title="首页" class="md-nav__link">
      首页
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      计算机
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        计算机
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../dstor数据接口定义/" title="Dstor数据访问接口定义" class="md-nav__link">
      Dstor数据访问接口定义
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2" checked>
    
    <label class="md-nav__link" for="nav-3-2">
      Linux
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        Linux
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        ELK+filebeat+kafka日志分析系统
      </label>
    
    <a href="./" title="ELK+filebeat+kafka日志分析系统" class="md-nav__link md-nav__link--active">
      ELK+filebeat+kafka日志分析系统
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" title="一、架构" class="md-nav__link">
    一、架构
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" title="二、测试环境介绍" class="md-nav__link">
    二、测试环境介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#java" title="三、部署java环境" class="md-nav__link">
    三、部署java环境
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31java" title="3.1、检查java环境" class="md-nav__link">
    3.1、检查java环境
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32jdk" title="3.2、安装JDK" class="md-nav__link">
    3.2、安装JDK
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elasticsearch" title="四、部署elasticsearch" class="md-nav__link">
    四、部署elasticsearch
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41elasticsearch" title="4.1、创建elasticsearch用户" class="md-nav__link">
    4.1、创建elasticsearch用户
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" title="4.2、调整系统参数" class="md-nav__link">
    4.2、调整系统参数
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#421" title="4.2.1、修改最大进程数限制" class="md-nav__link">
    4.2.1、修改最大进程数限制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#422vmmax_map_count" title="4.2.2、调整vm.max_map_count的值" class="md-nav__link">
    4.2.2、调整vm.max_map_count的值
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43elasticsearch" title="4.3、安装elasticsearch" class="md-nav__link">
    4.3、安装elasticsearch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44" title="4.4、修改配置文件" class="md-nav__link">
    4.4、修改配置文件
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#441master" title="4.4.1、master上的配置" class="md-nav__link">
    4.4.1、master上的配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#442datanode" title="4.4.2、datanode上的配置" class="md-nav__link">
    4.4.2、datanode上的配置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45elasticsearch" title="4.5、启动elasticsearch" class="md-nav__link">
    4.5、启动elasticsearch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#46" title="4.6、确认启动状态" class="md-nav__link">
    4.6、确认启动状态
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#47elasticsearch-head" title="4.7、使用elasticsearch-head插件" class="md-nav__link">
    4.7、使用elasticsearch-head插件
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#471node" title="4.7.1、部署node环境" class="md-nav__link">
    4.7.1、部署node环境
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#472elasticsearch-head" title="4.7.2、下载elasticsearch-head" class="md-nav__link">
    4.7.2、下载elasticsearch-head
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#473" title="4.7.3、安装依赖" class="md-nav__link">
    4.7.3、安装依赖
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#474gruntfilejs" title="4.7.4、修改Gruntfile.js配置" class="md-nav__link">
    4.7.4、修改Gruntfile.js配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#475elasticsearch-head" title="4.7.5、启动elasticsearch-head" class="md-nav__link">
    4.7.5、启动elasticsearch-head
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kafka" title="五、部署kafka" class="md-nav__link">
    五、部署kafka
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51kafka" title="5.1、安装kafka" class="md-nav__link">
    5.1、安装kafka
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52kafka" title="5.2、配置kafka" class="md-nav__link">
    5.2、配置kafka
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#52119216817zookeeper" title="5.2.1、192.168.1.7的zookeeper配置" class="md-nav__link">
    5.2.1、192.168.1.7的zookeeper配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52219216818zookeeper" title="5.2.2、192.168.1.8的zookeeper配置" class="md-nav__link">
    5.2.2、192.168.1.8的zookeeper配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52319216819zookeeper" title="5.2.3、192.168.1.9的zookeeper配置" class="md-nav__link">
    5.2.3、192.168.1.9的zookeeper配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52419216817kafka" title="5.2.4、192.168.1.7的kafka配置" class="md-nav__link">
    5.2.4、192.168.1.7的kafka配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52519216818kafka" title="5.2.5、192.168.1.8的kafka配置" class="md-nav__link">
    5.2.5、192.168.1.8的kafka配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52619216819kafka" title="5.2.6、192.168.1.9的kafka配置" class="md-nav__link">
    5.2.6、192.168.1.9的kafka配置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53zookeeper" title="5.3、启动zookeeper" class="md-nav__link">
    5.3、启动zookeeper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54kafka" title="5.4、启动kafka" class="md-nav__link">
    5.4、启动kafka
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#55" title="5.5、查看启动情况" class="md-nav__link">
    5.5、查看启动情况
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kibana" title="六、部署kibana" class="md-nav__link">
    六、部署kibana
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61kibana" title="6.1、下载安装kibana" class="md-nav__link">
    6.1、下载安装kibana
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62kibana" title="6.2、修改kibana配置" class="md-nav__link">
    6.2、修改kibana配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63kibana" title="6.3、启动kibana" class="md-nav__link">
    6.3、启动kibana
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64" title="6.4、查看启动情况" class="md-nav__link">
    6.4、查看启动情况
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65" title="6.5、浏览器访问" class="md-nav__link">
    6.5、浏览器访问
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filebeat" title="七、安装filebeat" class="md-nav__link">
    七、安装filebeat
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logstash" title="八、安装logstash" class="md-nav__link">
    八、安装logstash
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="九、测试过程" class="md-nav__link">
    九、测试过程
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91nginx" title="9.1、配置nginx" class="md-nav__link">
    9.1、配置nginx
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#911log_format" title="9.1.1、log_format" class="md-nav__link">
    9.1.1、log_format
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#912http_server" title="9.1.2、http_server" class="md-nav__link">
    9.1.2、http_server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#913" title="9.1.3、日志输出示例" class="md-nav__link">
    9.1.3、日志输出示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92filebeat" title="9.2、配置filebeat" class="md-nav__link">
    9.2、配置filebeat
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#921filebeatyml" title="9.2.1、filebeat.yml" class="md-nav__link">
    9.2.1、filebeat.yml
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#922filebeat" title="9.2.2、启动filebeat" class="md-nav__link">
    9.2.2、启动filebeat
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#923filebeat" title="9.2.3、filebeat输出内容格式：" class="md-nav__link">
    9.2.3、filebeat输出内容格式：
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93kafkatopic" title="9.3、kafka中创建topic" class="md-nav__link">
    9.3、kafka中创建topic
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#94logstash" title="9.4、配置logstash" class="md-nav__link">
    9.4、配置logstash
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#941logstashconf" title="9.4.1、logstash.conf" class="md-nav__link">
    9.4.1、logstash.conf
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#942logstash" title="9.4.2、启动logstash" class="md-nav__link">
    9.4.2、启动logstash
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#943logstash" title="9.4.3、logstash输出格式" class="md-nav__link">
    9.4.3、logstash输出格式
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#95es" title="9.5、查看ES中的内容" class="md-nav__link">
    9.5、查看ES中的内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#96kibanaes" title="9.6、kibana连接ES" class="md-nav__link">
    9.6、kibana连接ES
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#961index-pattern" title="9.6.1、创建index-pattern" class="md-nav__link">
    9.6.1、创建index-pattern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#962" title="9.6.2、查看日志" class="md-nav__link">
    9.6.2、查看日志
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux里面以指定用户运行命令/" title="linux里面以指定用户运行命令" class="md-nav__link">
      linux里面以指定用户运行命令
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../使ApacheBench支持multi-url/" title="使ApacheBench支持multi url" class="md-nav__link">
      使ApacheBench支持multi url
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../关于file-max和file-nr/" title="/proc/sys/fs/file-max" class="md-nav__link">
      /proc/sys/fs/file-max
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../编译安装kafka_exporter/" title="kafka_exporter" class="md-nav__link">
      kafka_exporter
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-3" type="checkbox" id="nav-3-3">
    
    <label class="md-nav__link" for="nav-3-3">
      Python
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-3">
        Python
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/matplotlib中文/" title="Matplotlib中文" class="md-nav__link">
      Matplotlib中文
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/列表和元组/" title="列表和元组" class="md-nav__link">
      列表和元组
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/基础知识/" title="基础知识" class="md-nav__link">
      基础知识
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/字典/" title="字典" class="md-nav__link">
      字典
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../python/字符串/" title="字符串" class="md-nav__link">
      字符串
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">
    
    <label class="md-nav__link" for="nav-3-4">
      网络
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        网络
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../网络/TCP-IP/" title="TCP IP" class="md-nav__link">
      TCP IP
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" title="一、架构" class="md-nav__link">
    一、架构
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" title="二、测试环境介绍" class="md-nav__link">
    二、测试环境介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#java" title="三、部署java环境" class="md-nav__link">
    三、部署java环境
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31java" title="3.1、检查java环境" class="md-nav__link">
    3.1、检查java环境
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32jdk" title="3.2、安装JDK" class="md-nav__link">
    3.2、安装JDK
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elasticsearch" title="四、部署elasticsearch" class="md-nav__link">
    四、部署elasticsearch
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41elasticsearch" title="4.1、创建elasticsearch用户" class="md-nav__link">
    4.1、创建elasticsearch用户
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" title="4.2、调整系统参数" class="md-nav__link">
    4.2、调整系统参数
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#421" title="4.2.1、修改最大进程数限制" class="md-nav__link">
    4.2.1、修改最大进程数限制
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#422vmmax_map_count" title="4.2.2、调整vm.max_map_count的值" class="md-nav__link">
    4.2.2、调整vm.max_map_count的值
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43elasticsearch" title="4.3、安装elasticsearch" class="md-nav__link">
    4.3、安装elasticsearch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44" title="4.4、修改配置文件" class="md-nav__link">
    4.4、修改配置文件
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#441master" title="4.4.1、master上的配置" class="md-nav__link">
    4.4.1、master上的配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#442datanode" title="4.4.2、datanode上的配置" class="md-nav__link">
    4.4.2、datanode上的配置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45elasticsearch" title="4.5、启动elasticsearch" class="md-nav__link">
    4.5、启动elasticsearch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#46" title="4.6、确认启动状态" class="md-nav__link">
    4.6、确认启动状态
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#47elasticsearch-head" title="4.7、使用elasticsearch-head插件" class="md-nav__link">
    4.7、使用elasticsearch-head插件
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#471node" title="4.7.1、部署node环境" class="md-nav__link">
    4.7.1、部署node环境
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#472elasticsearch-head" title="4.7.2、下载elasticsearch-head" class="md-nav__link">
    4.7.2、下载elasticsearch-head
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#473" title="4.7.3、安装依赖" class="md-nav__link">
    4.7.3、安装依赖
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#474gruntfilejs" title="4.7.4、修改Gruntfile.js配置" class="md-nav__link">
    4.7.4、修改Gruntfile.js配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#475elasticsearch-head" title="4.7.5、启动elasticsearch-head" class="md-nav__link">
    4.7.5、启动elasticsearch-head
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kafka" title="五、部署kafka" class="md-nav__link">
    五、部署kafka
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51kafka" title="5.1、安装kafka" class="md-nav__link">
    5.1、安装kafka
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52kafka" title="5.2、配置kafka" class="md-nav__link">
    5.2、配置kafka
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#52119216817zookeeper" title="5.2.1、192.168.1.7的zookeeper配置" class="md-nav__link">
    5.2.1、192.168.1.7的zookeeper配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52219216818zookeeper" title="5.2.2、192.168.1.8的zookeeper配置" class="md-nav__link">
    5.2.2、192.168.1.8的zookeeper配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52319216819zookeeper" title="5.2.3、192.168.1.9的zookeeper配置" class="md-nav__link">
    5.2.3、192.168.1.9的zookeeper配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52419216817kafka" title="5.2.4、192.168.1.7的kafka配置" class="md-nav__link">
    5.2.4、192.168.1.7的kafka配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52519216818kafka" title="5.2.5、192.168.1.8的kafka配置" class="md-nav__link">
    5.2.5、192.168.1.8的kafka配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52619216819kafka" title="5.2.6、192.168.1.9的kafka配置" class="md-nav__link">
    5.2.6、192.168.1.9的kafka配置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53zookeeper" title="5.3、启动zookeeper" class="md-nav__link">
    5.3、启动zookeeper
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54kafka" title="5.4、启动kafka" class="md-nav__link">
    5.4、启动kafka
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#55" title="5.5、查看启动情况" class="md-nav__link">
    5.5、查看启动情况
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kibana" title="六、部署kibana" class="md-nav__link">
    六、部署kibana
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61kibana" title="6.1、下载安装kibana" class="md-nav__link">
    6.1、下载安装kibana
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62kibana" title="6.2、修改kibana配置" class="md-nav__link">
    6.2、修改kibana配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63kibana" title="6.3、启动kibana" class="md-nav__link">
    6.3、启动kibana
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64" title="6.4、查看启动情况" class="md-nav__link">
    6.4、查看启动情况
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65" title="6.5、浏览器访问" class="md-nav__link">
    6.5、浏览器访问
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filebeat" title="七、安装filebeat" class="md-nav__link">
    七、安装filebeat
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logstash" title="八、安装logstash" class="md-nav__link">
    八、安装logstash
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" title="九、测试过程" class="md-nav__link">
    九、测试过程
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91nginx" title="9.1、配置nginx" class="md-nav__link">
    9.1、配置nginx
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#911log_format" title="9.1.1、log_format" class="md-nav__link">
    9.1.1、log_format
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#912http_server" title="9.1.2、http_server" class="md-nav__link">
    9.1.2、http_server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#913" title="9.1.3、日志输出示例" class="md-nav__link">
    9.1.3、日志输出示例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92filebeat" title="9.2、配置filebeat" class="md-nav__link">
    9.2、配置filebeat
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#921filebeatyml" title="9.2.1、filebeat.yml" class="md-nav__link">
    9.2.1、filebeat.yml
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#922filebeat" title="9.2.2、启动filebeat" class="md-nav__link">
    9.2.2、启动filebeat
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#923filebeat" title="9.2.3、filebeat输出内容格式：" class="md-nav__link">
    9.2.3、filebeat输出内容格式：
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#93kafkatopic" title="9.3、kafka中创建topic" class="md-nav__link">
    9.3、kafka中创建topic
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#94logstash" title="9.4、配置logstash" class="md-nav__link">
    9.4、配置logstash
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#941logstashconf" title="9.4.1、logstash.conf" class="md-nav__link">
    9.4.1、logstash.conf
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#942logstash" title="9.4.2、启动logstash" class="md-nav__link">
    9.4.2、启动logstash
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#943logstash" title="9.4.3、logstash输出格式" class="md-nav__link">
    9.4.3、logstash输出格式
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#95es" title="9.5、查看ES中的内容" class="md-nav__link">
    9.5、查看ES中的内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#96kibanaes" title="9.6、kibana连接ES" class="md-nav__link">
    9.6、kibana连接ES
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#961index-pattern" title="9.6.1、创建index-pattern" class="md-nav__link">
    9.6.1、创建index-pattern
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#962" title="9.6.2、查看日志" class="md-nav__link">
    9.6.2、查看日志
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>ELK+filebeat+kafka日志分析系统</h1>
                
                <h2 id="_1">一、架构<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>filebeat=&gt;kafka=&gt;logstash=&gt;elasticsearch=&gt;kibana</p>
<h2 id="_2">二、测试环境介绍<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th></th>
<th>操作系统</th>
<th>java环境</th>
<th>角色</th>
<th>对应服务版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.1.1</td>
<td>centos 6.7</td>
<td>java version "1.8.0_191"</td>
<td>Elasticsearch-master</td>
<td>elasticsearch-6.5.1+elasticsearch-head插件</td>
</tr>
<tr>
<td>192.168.1.2</td>
<td>centos 6.7</td>
<td>java version "1.8.0_191"</td>
<td>Elasticsearch-datanode</td>
<td>elasticsearch-6.5.1</td>
</tr>
<tr>
<td>192.168.1.3</td>
<td>centos 6.7</td>
<td>java version "1.8.0_191"</td>
<td>Elasticsearch-datanode</td>
<td>elasticsearch-6.5.1</td>
</tr>
<tr>
<td>192.168.1.4</td>
<td>centos 6.7</td>
<td>java version "1.8.0_191"</td>
<td>Logstash</td>
<td>logstash-6.5.1</td>
</tr>
<tr>
<td>192.168.1.5</td>
<td>centos 6.7</td>
<td>无</td>
<td>kibana</td>
<td>kibana-6.5.1</td>
</tr>
<tr>
<td>192.168.1.6</td>
<td>centos 6.7</td>
<td>无</td>
<td>filebeat</td>
<td>filebeat-6.5.1</td>
</tr>
<tr>
<td>192.168.1.7</td>
<td>centos 6.7</td>
<td>java version "1.8.0_191"</td>
<td>Kafka+Zookeeper</td>
<td>kafka_2.11-0.11.0.2+kafka自带zookeeper</td>
</tr>
<tr>
<td>192.168.1.8</td>
<td>centos 6.7</td>
<td>java version "1.8.0_191"</td>
<td>Kafka+Zookeeper</td>
<td>kafka_2.11-0.11.0.2+kafka自带zookeeper</td>
</tr>
<tr>
<td>192.168.1.9</td>
<td>centos 6.7</td>
<td>java version "1.8.0_191"</td>
<td>Kafka+Zookeeper</td>
<td>kafka_2.11-0.11.0.2+kafka自带zookeeper</td>
</tr>
</tbody>
</table>
<h2 id="java">三、部署java环境<a class="headerlink" href="#java" title="Permanent link">&para;</a></h2>
<blockquote>
<p>除filebea和kibana以外的角色服务器上都要进行</p>
</blockquote>
<h3 id="31java">3.1、检查java环境<a class="headerlink" href="#31java" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>java -version
<span class="nb">echo</span> <span class="nv">$JAVA_HOME</span>
</pre></div>
</td></tr></table>

<blockquote>
<p>Elasticsearch requires at least Java 8.Before you install Elasticsearch, please check your Java version first by running (and then install/upgrade accordingly if needed):</p>
</blockquote>
<h3 id="32jdk">3.2、安装JDK<a class="headerlink" href="#32jdk" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> /usr/local/src/
wget --no-check-certificate --no-cookies --header <span class="s2">&quot;Cookie: oraclelicense=accept-securebackup-cookie&quot;</span> https://download.oracle.com/otn-pub/java/jdk/8u191-b12/2787e4a523244c269598db4e85c51e0c/jdk-8u191-linux-x64.rpm
rpm -ivh jdk-8u191-linux-x64.rpm
</pre></div>
</td></tr></table>

<h2 id="elasticsearch">四、部署elasticsearch<a class="headerlink" href="#elasticsearch" title="Permanent link">&para;</a></h2>
<blockquote>
<p>在<code>192.168.1.1</code>、<code>192.168.1.2</code>和<code>192.168.1.3</code>上面都要进行</p>
</blockquote>
<h3 id="41elasticsearch">4.1、创建elasticsearch用户<a class="headerlink" href="#41elasticsearch" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>groupadd elasticsearch
useradd elasticsearch -g elasticsearch 
</pre></div>
</td></tr></table>

<blockquote>
<p>由于ElasticSearch可以接收用户输入的脚本并且执行，为了系统安全考虑， 建议创建一个单独的用户用来运行ElasticSearch。以root身份启动elasticsearch的时候，会遇到以下报错：</p>
</blockquote>
<p><img alt="elasticsearch" src="../../../img/elasticsearch_root.png" /></p>
<h3 id="42">4.2、调整系统参数<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<h4 id="421">4.2.1、修改最大进程数限制<a class="headerlink" href="#421" title="Permanent link">&para;</a></h4>
<p>修改<code>/etc/security/limits.d/90-nproc.conf</code>中的<code>*</code>用户对应的最大进程为<code>4096</code></p>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># Default limit for number of user&#39;s processes to prevent</span>
<span class="c1"># accidental fork bombs.</span>
<span class="c1"># See rhbz #432903 for reasoning.</span>

*          soft    nproc     <span class="m">4096</span>
root       soft    nproc     unlimited
</pre></div>
</td></tr></table>
否则会遇到下面的报错：
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[1]: max number of threads [1024] for user [elasticsearch] is too low, increase to at least [4096]
</pre></div>
</td></tr></table></p>
<h4 id="422vmmax_map_count">4.2.2、调整<code>vm.max_map_count</code>的值<a class="headerlink" href="#422vmmax_map_count" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>sed -i <span class="s1">&#39;/vm.max_map_count/d&#39;</span> /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">&quot;vm.max_map_count=262144&quot;</span> &gt;&gt; /etc/sysctl.conf
sysctl -w vm.max_map_count<span class="o">=</span><span class="m">262144</span>
</pre></div>
</td></tr></table>

<p>否则会遇到以下报错</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>[2]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]
</pre></div>
</td></tr></table>

<h3 id="43elasticsearch">4.3、安装elasticsearch<a class="headerlink" href="#43elasticsearch" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> /usr/local
wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.5.1.tar.gz
tar -zxf elasticsearch-6.5.1.tar.gz
chown -R elasticsearch:elasticsearch elasticsearch-6.5.1
ln -s elasticsearch-6.5.1 elasticsearch
</pre></div>
</td></tr></table>

<h3 id="44">4.4、修改配置文件<a class="headerlink" href="#44" title="Permanent link">&para;</a></h3>
<h4 id="441master">4.4.1、master上的配置<a class="headerlink" href="#441master" title="Permanent link">&para;</a></h4>
<p>编辑<code>config/elasticsearch.yml</code>,在文件末尾添加如下配置：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">http.cors.enabled</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="l l-Scalar l-Scalar-Plain">http.cors.allow-origin</span><span class="p p-Indicator">:</span> <span class="s">&quot;*&quot;</span>  <span class="c1">#这两个选项是为了能够使用head插件，根据需要进行配置</span>

<span class="l l-Scalar l-Scalar-Plain">cluster.name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">wqytest</span>
<span class="l l-Scalar l-Scalar-Plain">node.name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">master</span>
<span class="l l-Scalar l-Scalar-Plain">node.master</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="l l-Scalar l-Scalar-Plain">node.data</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="l l-Scalar l-Scalar-Plain">network.host</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.1</span>
</pre></div>
</td></tr></table>

<h4 id="442datanode">4.4.2、datanode上的配置<a class="headerlink" href="#442datanode" title="Permanent link">&para;</a></h4>
<p>编辑<code>config/elasticsearch.yml</code>,在文件末尾添加如下配置：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">cluster.name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">wqytest</span>
<span class="l l-Scalar l-Scalar-Plain">node.name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">data-node01</span>     <span class="c1">#192.168.1.3上面此处name换为data-node02</span>
<span class="l l-Scalar l-Scalar-Plain">node.master</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="l l-Scalar l-Scalar-Plain">node.data</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="l l-Scalar l-Scalar-Plain">network.host</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.2</span>   <span class="c1">#192.168.1.3上面此处ip换为192.168.1.3</span>
<span class="l l-Scalar l-Scalar-Plain">discovery.zen.ping.unicast.hosts</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;192.168.1.1&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
</td></tr></table>

<h3 id="45elasticsearch">4.5、启动elasticsearch<a class="headerlink" href="#45elasticsearch" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>su elasticsearch
/usr/local/elasticsearch/bin/elasticsearch -d
</pre></div>
</td></tr></table>

<h3 id="46">4.6、确认启动状态<a class="headerlink" href="#46" title="Permanent link">&para;</a></h3>
<p>执行<code>curl http://yourhostip:9200</code>看到以下输出，即表明启动正常：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;data-node01&quot;</span><span class="p">,</span>
  <span class="nt">&quot;cluster_name&quot;</span> <span class="p">:</span> <span class="s2">&quot;wqytest&quot;</span><span class="p">,</span>
  <span class="nt">&quot;cluster_uuid&quot;</span> <span class="p">:</span> <span class="s2">&quot;0-jj-5-dTW-O7lFaYWQuzw&quot;</span><span class="p">,</span>
  <span class="nt">&quot;version&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;number&quot;</span> <span class="p">:</span> <span class="s2">&quot;6.5.1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;build_flavor&quot;</span> <span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="nt">&quot;build_type&quot;</span> <span class="p">:</span> <span class="s2">&quot;tar&quot;</span><span class="p">,</span>
    <span class="nt">&quot;build_hash&quot;</span> <span class="p">:</span> <span class="s2">&quot;8c58350&quot;</span><span class="p">,</span>
    <span class="nt">&quot;build_date&quot;</span> <span class="p">:</span> <span class="s2">&quot;2018-11-16T02:22:42.182257Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;build_snapshot&quot;</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;lucene_version&quot;</span> <span class="p">:</span> <span class="s2">&quot;7.5.0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;minimum_wire_compatibility_version&quot;</span> <span class="p">:</span> <span class="s2">&quot;5.6.0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;minimum_index_compatibility_version&quot;</span> <span class="p">:</span> <span class="s2">&quot;5.0.0&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;tagline&quot;</span> <span class="p">:</span> <span class="s2">&quot;You Know, for Search&quot;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h3 id="47elasticsearch-head">4.7、使用elasticsearch-head插件<a class="headerlink" href="#47elasticsearch-head" title="Permanent link">&para;</a></h3>
<h4 id="471node">4.7.1、部署node环境<a class="headerlink" href="#471node" title="Permanent link">&para;</a></h4>
<p>(1)、下载node包</p>
<blockquote>
<p>可以前往<code>https://nodejs.org/en/download/</code>查找适合自己node包</p>
</blockquote>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> /usr/local/
wget https://nodejs.org/dist/v10.13.0/node-v10.13.0-linux-x64.tar.xz
tar -Jxf node-v10.13.0-linux-x64.tar.xz
ln -s node-v10.13.0-linux-x64 node
</pre></div>
</td></tr></table>

<p>(2)、设置node环境变量</p>
<p>编辑<code>/etc/profile</code>在文件末尾添加以下配置：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>NODE_HOME=/usr/local/node
PATH=$PATH:$NODE_HOME/bin
NODE_PATH=$NODE_HOME/lib/node_modules
export NODE_HOME PATH NODE_PATH
</pre></div>
</td></tr></table>

<h4 id="472elasticsearch-head">4.7.2、下载<code>elasticsearch-head</code><a class="headerlink" href="#472elasticsearch-head" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>cd /usr/local/
wget https://github.com/mobz/elasticsearch-head/archive/master.zip
unzip master.zip
</pre></div>
</td></tr></table>

<h4 id="473">4.7.3、安装依赖<a class="headerlink" href="#473" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> /usr/local/elasticsearch-head-master
npm install
</pre></div>
</td></tr></table>

<h4 id="474gruntfilejs">4.7.4、修改Gruntfile.js配置<a class="headerlink" href="#474gruntfilejs" title="Permanent link">&para;</a></h4>
<p>编辑<code>Gruntfile.js</code>文件，搜索关键词<code>connect</code>,增加<code>hostname</code>设置，如下：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>                connect: {
                        server: {
                                options: {
                                        hostname: &#39;0.0.0.0&#39;,
                                        port: 9100,
                                        base: &#39;.&#39;,
                                        keepalive: true
                                }
                        }
                }
</pre></div>
</td></tr></table>

<h4 id="475elasticsearch-head">4.7.5、启动elasticsearch-head<a class="headerlink" href="#475elasticsearch-head" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>cd /usr/local/elasticsearch-head-master
nohup npm run start &amp;
</pre></div>
</td></tr></table>

<blockquote>
<p>head插件的页面操作此处不做展开说明</p>
</blockquote>
<h2 id="kafka">五、部署kafka<a class="headerlink" href="#kafka" title="Permanent link">&para;</a></h2>
<blockquote>
<p>在<code>192.168.1.7</code>、<code>192.168.1.8</code>和<code>192.168.1.9</code>上面都要进行,在实际部署时，kafka节点要保证最少三台，因为filebeat在连接kafka时就要求最少要有三个kafka节点（重要！！！）</p>
</blockquote>
<h3 id="51kafka">5.1、安装kafka<a class="headerlink" href="#51kafka" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> /usr/local/
wget https://archive.apache.org/dist/kafka/0.11.0.2/kafka_2.11-0.11.0.2.tgz
tar -zxf kafka_2.11-0.11.0.2.tgz
ln -s kafka_2.11-0.11.0.2 kafka
</pre></div>
</td></tr></table>

<h3 id="52kafka">5.2、配置kafka<a class="headerlink" href="#52kafka" title="Permanent link">&para;</a></h3>
<h4 id="52119216817zookeeper">5.2.1、192.168.1.7的zookeeper配置<a class="headerlink" href="#52119216817zookeeper" title="Permanent link">&para;</a></h4>
<p>备份<code>config/zookeeper.properties</code>然后清空该文件并添加如下配置内容：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>tickTime=2000
initLimit=10
syncLimit=5
dataDir=/tmp/zookeeper
clientPort=2181
clientPortAddress=192.168.1.7
server.1=192.168.1.7:2888:3888
server.2=192.168.1.8:2888:3888
server.3=192.168.1.9:2888:3888
</pre></div>
</td></tr></table>

<blockquote>
<p>2181端口是zookeeper对外的服务端口，zookeeper集群中的每个节点上都有2181端口；2888端口是zookeeper中的leader节点用来与follower节点通信的服务端口，只有在leader节点上才能看到2888端口；3888端口是在选举leader时投票的通信端口，zookeeper集群中的每个节点上都有3888端口。</p>
</blockquote>
<h4 id="52219216818zookeeper">5.2.2、192.168.1.8的zookeeper配置<a class="headerlink" href="#52219216818zookeeper" title="Permanent link">&para;</a></h4>
<p>备份<code>config/zookeeper.properties</code>然后清空该文件并添加如下配置内容：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>tickTime=2000
initLimit=10
syncLimit=5
dataDir=/tmp/zookeeper
clientPort=2181
clientPortAddress=192.168.1.8
server.1=192.168.1.7:2888:3888
server.2=192.168.1.8:2888:3888
server.3=192.168.1.9:2888:3888
</pre></div>
</td></tr></table>

<h4 id="52319216819zookeeper">5.2.3、192.168.1.9的zookeeper配置<a class="headerlink" href="#52319216819zookeeper" title="Permanent link">&para;</a></h4>
<p>备份<code>config/zookeeper.properties</code>然后清空该文件并添加如下配置内容：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>tickTime=2000
initLimit=10
syncLimit=5
dataDir=/tmp/zookeeper
clientPort=2181
clientPortAddress=192.168.1.9
server.1=192.168.1.7:2888:3888
server.2=192.168.1.8:2888:3888
server.3=192.168.1.9:2888:3888
</pre></div>
</td></tr></table>

<h4 id="52419216817kafka">5.2.4、192.168.1.7的kafka配置<a class="headerlink" href="#52419216817kafka" title="Permanent link">&para;</a></h4>
<p>备份<code>config/server.properties</code>然后清空该文件并添加如下配置内容：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>broker.id=1     #kafka集群中的每个broker需要拥有一个唯一的id
delete.topic.enable=true
listeners=PLAINTEXT://192.168.1.7:9092
port=9092
host.name=192.168.1.7
num.network.threads=12
num.io.threads=12
num.replica.fetchers=8
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600
log.dirs=/tmp/kafka-logs
num.partitions=1
default.replication.factor=3
num.recovery.threads.per.data.dir=4
auto.create.topics.enable=false
offsets.retention.minutes=43200
log.retention.hours=4380
log.segment.bytes=1073741824
log.retention.check.interval.ms=300000
log.cleaner.enable=true
zookeeper.connect=192.168.1.7:2181,192.168.1.8:2181,192.168.1.9:2181/kafka
zookeeper.connection.timeout.ms=6000
</pre></div>
</td></tr></table>

<h4 id="52519216818kafka">5.2.5、192.168.1.8的kafka配置<a class="headerlink" href="#52519216818kafka" title="Permanent link">&para;</a></h4>
<p>备份<code>config/server.properties</code>然后清空该文件并添加如下配置内容：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>broker.id=2
delete.topic.enable=true
listeners=PLAINTEXT://192.168.1.8:9092
port=9092
host.name=192.168.1.8
num.network.threads=12
num.io.threads=12
num.replica.fetchers=8
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600
log.dirs=/tmp/kafka-logs
num.partitions=1
default.replication.factor=3
num.recovery.threads.per.data.dir=4
auto.create.topics.enable=false
offsets.retention.minutes=43200
log.retention.hours=4380
log.segment.bytes=1073741824
log.retention.check.interval.ms=300000
log.cleaner.enable=true
zookeeper.connect=192.168.1.7:2181,192.168.1.8:2181,192.168.1.9:2181/kafka
zookeeper.connection.timeout.ms=6000
</pre></div>
</td></tr></table>

<h4 id="52619216819kafka">5.2.6、192.168.1.9的kafka配置<a class="headerlink" href="#52619216819kafka" title="Permanent link">&para;</a></h4>
<p>备份<code>config/server.properties</code>然后清空该文件并添加如下配置内容：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>broker.id=3
delete.topic.enable=true
listeners=PLAINTEXT://192.168.1.9:9092
port=9092
host.name=192.168.1.9
num.network.threads=12
num.io.threads=12
num.replica.fetchers=8
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600
log.dirs=/tmp/kafka-logs
num.partitions=1
default.replication.factor=3
num.recovery.threads.per.data.dir=4
auto.create.topics.enable=false
offsets.retention.minutes=43200
log.retention.hours=4380
log.segment.bytes=1073741824
log.retention.check.interval.ms=300000
log.cleaner.enable=true
zookeeper.connect=192.168.1.7:2181,192.168.1.8:2181,192.168.1.9:2181/kafka
zookeeper.connection.timeout.ms=6000
</pre></div>
</td></tr></table>

<h3 id="53zookeeper">5.3、启动zookeeper<a class="headerlink" href="#53zookeeper" title="Permanent link">&para;</a></h3>
<p>需要在<code>192.168.1.7</code>、<code>192.168.1.8</code>和<code>192.168.1.9</code>上分别执行</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> /usr/local/kafka
nohup bin/zookeeper-server-start.sh config/zookeeper.properties <span class="p">&amp;</span>
</pre></div>
</td></tr></table>

<h3 id="54kafka">5.4、启动kafka<a class="headerlink" href="#54kafka" title="Permanent link">&para;</a></h3>
<p>需要在<code>192.168.1.7</code>、<code>192.168.1.8</code>和<code>192.168.1.9</code>上分别执行</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> /usr/local/kafka
nohup bin/kafka-server-start.sh config/server.properties <span class="p">&amp;</span>
</pre></div>
</td></tr></table>

<h3 id="55">5.5、查看启动情况<a class="headerlink" href="#55" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1"># netstat -nlpt|grep java</span>
tcp6       <span class="m">0</span>      <span class="m">0</span> :::44556                :::*                    LISTEN      <span class="m">17908</span>/java
tcp6       <span class="m">0</span>      <span class="m">0</span> <span class="m">192</span>.168.1.8:3888      :::*                    LISTEN      <span class="m">17908</span>/java
tcp6       <span class="m">0</span>      <span class="m">0</span> :::42993                :::*                    LISTEN      <span class="m">18748</span>/java
tcp6       <span class="m">0</span>      <span class="m">0</span> <span class="m">192</span>.168.1.8:9092      :::*                    LISTEN      <span class="m">18748</span>/java
tcp6       <span class="m">0</span>      <span class="m">0</span> <span class="m">192</span>.168.1.8:2181      :::*                    LISTEN      <span class="m">17908</span>/java
</pre></div>
</td></tr></table>

<h2 id="kibana">六、部署kibana<a class="headerlink" href="#kibana" title="Permanent link">&para;</a></h2>
<h3 id="61kibana">6.1、下载安装kibana<a class="headerlink" href="#61kibana" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> /usr/local/
wget https://artifacts.elastic.co/downloads/kibana/kibana-6.5.1-linux-x86_64.tar.gz
tar -zxf kibana-6.5.1-linux-x86_64.tar.gz
ln -s kibana-6.5.1-linux-x86_64 kibana
</pre></div>
</td></tr></table>

<h3 id="62kibana">6.2、修改kibana配置<a class="headerlink" href="#62kibana" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">#vim config/kibana.yml</span>
server.port: <span class="m">5601</span>  <span class="c1"># 配置kibana的端口</span>
server.host: <span class="m">192</span>.168.1.5  <span class="c1"># 配置监听ip</span>
elasticsearch.url: <span class="s2">&quot;http://192.168.1.1:9200&quot;</span>
logging.dest: /var/log/kibana.log  <span class="c1">#默认是记录到messages里面</span>
</pre></div>
</td></tr></table>

<h3 id="63kibana">6.3、启动kibana<a class="headerlink" href="#63kibana" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>./bin/kibana
</pre></div>
</td></tr></table>

<blockquote>
<p>By default, Kibana runs in the foreground, prints its logs to the standard output (<code>stdout</code>), and can be stopped by pressing <strong>Ctrl-C</strong>.</p>
</blockquote>
<h3 id="64">6.4、查看启动情况<a class="headerlink" href="#64" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">#netstat -nlpt|grep node</span>
tcp        <span class="m">0</span>      <span class="m">0</span> <span class="m">192</span>.168.1.5:5601      <span class="m">0</span>.0.0.0:*               LISTEN      <span class="m">6580</span>/./bin/../node/
<span class="c1">#ps aux|grep node</span>
root      <span class="m">6580</span>  <span class="m">8</span>.7  <span class="m">0</span>.2 <span class="m">1443252</span> <span class="m">300312</span> pts/0  Sl+  <span class="m">19</span>:30   <span class="m">0</span>:14 ./bin/../node/bin/node --no-warnings ./bin/../src/cli
</pre></div>
</td></tr></table>

<blockquote>
<p>由于kibana是使用node.js开发的，所以进程名称为node</p>
</blockquote>
<h3 id="65">6.5、浏览器访问<a class="headerlink" href="#65" title="Permanent link">&para;</a></h3>
<p>通过浏览器访问<code>http://192.168.1.5:5601</code>，可以看到类似如下的界面：</p>
<p><img alt="kibana" src="../../../img/kibana.png" /></p>
<h2 id="filebeat">七、安装filebeat<a class="headerlink" href="#filebeat" title="Permanent link">&para;</a></h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> /usr/local/
wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.5.1-linux-x86_64.tar.gz
tar -zxf filebeat-6.5.1-linux-x86_64.tar.gz
ln -s filebeat-6.5.1 filebeat
</pre></div>
</td></tr></table>

<h2 id="logstash">八、安装logstash<a class="headerlink" href="#logstash" title="Permanent link">&para;</a></h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nb">cd</span> /usr/local
wget https://artifacts.elastic.co/downloads/logstash/logstash-6.5.1.tar.gz
tar -zxf logstash-6.5.1.tar.gz
ln -s logstash-6.5.1 logstash
</pre></div>
</td></tr></table>

<h2 id="_3">九、测试过程<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="91nginx">9.1、配置nginx<a class="headerlink" href="#91nginx" title="Permanent link">&para;</a></h3>
<h4 id="911log_format">9.1.1、log_format<a class="headerlink" href="#911log_format" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">log_format</span> <span class="s">test</span> <span class="s">&#39;</span><span class="nv">$remote_addr\t$msec\t$request_method\t$scheme://$host$request_uri\t$bytes_sent\t$request_time&#39;</span><span class="p">;</span>
</pre></div>
</td></tr></table>

<h4 id="912http_server">9.1.2、http_server<a class="headerlink" href="#912http_server" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>        <span class="k">server</span> <span class="p">{</span>
                <span class="kn">access_log</span> <span class="s">/usr/local/nginx/logs/test.access.log</span> <span class="s">test</span><span class="p">;</span>
                <span class="kn">server_name</span> <span class="s">www.test.com</span><span class="p">;</span>
                <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
                <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span>
        <span class="p">}</span>
</pre></div>
</td></tr></table>

<h4 id="913">9.1.3、日志输出示例<a class="headerlink" href="#913" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="m">192</span>.168.10.2    <span class="m">1543314863</span>.426  GET http://www.test.com/video/666.m3u8?start<span class="o">=</span><span class="m">8702242</span>    <span class="m">336</span> <span class="m">0</span>.000
</pre></div>
</td></tr></table>

<h3 id="92filebeat">9.2、配置filebeat<a class="headerlink" href="#92filebeat" title="Permanent link">&para;</a></h3>
<h4 id="921filebeatyml">9.2.1、filebeat.yml<a class="headerlink" href="#921filebeatyml" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">#vim filebeat.yml</span>
name: <span class="m">61</span>.160.243.126
filebeat.inputs:
- type: log
  paths:
    - /usr/local/nginx/logs/test.access.log
  fields:
    logtype: nginxaccesslog
output.kafka:
  codec.json:
    pretty: <span class="nb">true</span>
    escape_html: <span class="nb">false</span>
  hosts: <span class="o">[</span><span class="s2">&quot;192.168.1.7:9092&quot;</span>,<span class="s2">&quot;192.168.1.8:9092&quot;</span>,<span class="s2">&quot;192.168.1.9:9092&quot;</span><span class="o">]</span>
  topic: <span class="nb">test</span>
  partition.round_robin:
    reachable_only: <span class="nb">false</span>

  required_acks: <span class="m">1</span>
  compression: gzip
  max_message_bytes: <span class="m">1000000</span>
</pre></div>
</td></tr></table>

<blockquote>
<p>有关filebeat的log input的配置介绍见官网文档<code>https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-log.html</code></p>
<p>有关filebeat output到kafka的配置介绍见官方文档<code>https://www.elastic.co/guide/en/beats/filebeat/current/kafka-output.html</code></p>
</blockquote>
<h4 id="922filebeat">9.2.2、启动filebeat<a class="headerlink" href="#922filebeat" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>./filebeat -e -c filebeat.yml
</pre></div>
</td></tr></table>

<h4 id="923filebeat">9.2.3、filebeat输出内容格式：<a class="headerlink" href="#923filebeat" title="Permanent link">&para;</a></h4>
<blockquote>
<p>为了看到filebeat的输入内容，可以设置output到console，启动filebeat后可以直接在终端中看输出的内容
</p>
</blockquote>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">#vim filebeat-ouput-stdout.yml</span>
<span class="l l-Scalar l-Scalar-Plain">filebeat.inputs</span><span class="p p-Indicator">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">log</span>
  <span class="l l-Scalar l-Scalar-Plain">paths</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/usr/local/nginx/logs/test.access.log</span>
  <span class="l l-Scalar l-Scalar-Plain">fields</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">logtype</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nginxaccesslog</span>
<span class="l l-Scalar l-Scalar-Plain">output.console</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">pretty</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</td></tr></table>

<p>内容格式如下：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;@timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-12-10T08:41:22.427Z&quot;</span><span class="p">,</span>
  <span class="nt">&quot;@metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;beat&quot;</span><span class="p">:</span> <span class="s2">&quot;filebeat&quot;</span><span class="p">,</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;doc&quot;</span><span class="p">,</span>
    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;6.5.1&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.1.6&quot;</span><span class="p">,</span>
    <span class="nt">&quot;architecture&quot;</span><span class="p">:</span> <span class="s2">&quot;x86_64&quot;</span><span class="p">,</span>
    <span class="nt">&quot;os&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;platform&quot;</span><span class="p">:</span> <span class="s2">&quot;centos&quot;</span><span class="p">,</span>
      <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;6.7 ()&quot;</span><span class="p">,</span>
      <span class="nt">&quot;family&quot;</span><span class="p">:</span> <span class="s2">&quot;redhat&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;containerized&quot;</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="nt">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;/usr/local/nginx/logs/test.access.log&quot;</span><span class="p">,</span>
  <span class="nt">&quot;offset&quot;</span><span class="p">:</span> <span class="mi">9330</span><span class="p">,</span>
  <span class="nt">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;61.135.155.34\t1544431279.302\tGET\thttp://www.test.com/etc.tar.gz\t82183\t0.074&quot;</span><span class="p">,</span>
  <span class="nt">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;logtype&quot;</span><span class="p">:</span> <span class="s2">&quot;nginxaccesslog&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;prospector&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;log&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;input&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;log&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;beat&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;61.160.243.126&quot;</span><span class="p">,</span>
    <span class="nt">&quot;hostname&quot;</span><span class="p">:</span> <span class="s2">&quot;DEVSTOR-JSCZ-goofys-243-126&quot;</span><span class="p">,</span>
    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;6.5.1&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h3 id="93kafkatopic">9.3、kafka中创建topic<a class="headerlink" href="#93kafkatopic" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>/usr/local/kafka/bin/kafka-topics.sh --create --zookeeper 192.168.1.7:2181/kafka --replication-factor 1 --partitions 1 --topic test
</pre></div>
</td></tr></table>

<p>通过查看topic列表验证topic是否创建成功：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span># /usr/local/kafka/bin/kafka-topics.sh --list  --zookeeper 192.168.1.7:2181/kafka
__consumer_offsets
test
</pre></div>
</td></tr></table>

<h3 id="94logstash">9.4、配置logstash<a class="headerlink" href="#94logstash" title="Permanent link">&para;</a></h3>
<h4 id="941logstashconf">9.4.1、logstash.conf<a class="headerlink" href="#941logstashconf" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>input {
  kafka {
    bootstrap_servers =&gt; [&quot;192.168.1.7:9092&quot;]
    topics =&gt; [&quot;test&quot;]
    group_id =&gt; &quot;test&quot;
    codec =&gt; &quot;json&quot;
    consumer_threads =&gt; 1
    decorate_events =&gt; true
  }
}

filter {
    if [fields][logtype] == &quot;nginxaccesslog&quot; {
            grok {
            match =&gt; { &quot;message&quot; =&gt; &quot;%{IPV4:client}\t%{NUMBER:msec}\t%{WORD:method}\t%{URI:url}\t%{NUMBER:bytes}\t%{NUMBER:duration}&quot; }
            remove_field =&gt; &quot;message&quot;
            }
    }
    mutate {
          remove_field =&gt; &quot;offset&quot;
          remove_field =&gt; &quot;prospector&quot;
          remove_field =&gt; &quot;input&quot;
          remove_field =&gt; &quot;host&quot;
          remove_field =&gt; &quot;@version&quot;
    }
}

output {
    if &quot;_grokparsefailure&quot; not in [tags] {
        if [fields][logtype] == &quot;nginxaccesslog&quot; {
            elasticsearch {
                hosts =&gt; [&quot;192.168.1.1:9200&quot;]
                index =&gt; &quot;nginx-access-%{+YYYY.MM}&quot;
            }
        }
        elseif [fields][logtype] == &quot;system-syslog&quot; {
            elasticsearch {
                hosts =&gt; [&quot;192.168.1.1:9200&quot;]
                index =&gt; &quot;system-syslog-%{+YYYY.MM}&quot;
            }
        }
    }
}
</pre></div>
</td></tr></table>

<blockquote>
<p>有关logstash中kafka-input的配置介绍见官方文档：<code>https://www.elastic.co/guide/en/logstash/current/plugins-inputs-kafka.html</code></p>
<p>有关logstash中grok-filter的配置介绍见官方文档：<code>https://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html</code></p>
<p>有关logstash中output-elasticsearch的配置介绍见官方文档：<code>https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html</code></p>
</blockquote>
<h4 id="942logstash">9.4.2、启动logstash<a class="headerlink" href="#942logstash" title="Permanent link">&para;</a></h4>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">#./bin/logstash --path.settings config -f config/logstash.conf</span>
</pre></div>
</td></tr></table>

<h4 id="943logstash">9.4.3、logstash输出格式<a class="headerlink" href="#943logstash" title="Permanent link">&para;</a></h4>
<p>logstash中最为关键的地方在于<code>filter</code>,为了调试<code>filter</code>的配置，可以配置logstash输出内容到终端上面</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>input {
  kafka {
    bootstrap_servers =&gt; [&quot;192.168.1.7:9092&quot;]
    topics =&gt; [&quot;test&quot;]
    group_id =&gt; &quot;test&quot;
    codec =&gt; &quot;json&quot;
    consumer_threads =&gt; 1
    decorate_events =&gt; true
  }
}
filter {
    if [fields][logtype] == &quot;nginxaccesslog&quot; {
            grok {
            match =&gt; { &quot;message&quot; =&gt; &quot;%{IPV4:client}\t%{NUMBER:msec}\t%{WORD:method}\t%{URI:url}\t%{NUMBER:bytes}\t%{NUMBER:duration}&quot; }
            remove_field =&gt; &quot;message&quot;
            }
    }
    mutate {
          remove_field =&gt; &quot;offset&quot;
          remove_field =&gt; &quot;prospector&quot;
          remove_field =&gt; &quot;input&quot;
          remove_field =&gt; &quot;host&quot;
          remove_field =&gt; &quot;@version&quot;
    }
}
output {stdout{}}
</pre></div>
</td></tr></table>

<p>输入内容格式如下：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>{
        &quot;fields&quot; =&gt; {
        &quot;logtype&quot; =&gt; &quot;nginxaccesslog&quot;
    },
         &quot;bytes&quot; =&gt; &quot;82183&quot;,
    &quot;@timestamp&quot; =&gt; 2018-12-10T08:38:53.284Z,
          &quot;beat&quot; =&gt; {
        &quot;hostname&quot; =&gt; &quot;DEVSTOR-JSCZ-goofys-243-126&quot;,
         &quot;version&quot; =&gt; &quot;6.5.1&quot;,
            &quot;name&quot; =&gt; &quot;192.168.1.6&quot;
    },
        &quot;source&quot; =&gt; &quot;/usr/local/nginx/logs/test.access.log&quot;,
        &quot;client&quot; =&gt; &quot;122.11.50.246&quot;,
           &quot;url&quot; =&gt; &quot;http://www.test.com/etc.tar.gz&quot;,
          &quot;msec&quot; =&gt; &quot;1544112583.706&quot;,
        &quot;method&quot; =&gt; &quot;GET&quot;,
      &quot;duration&quot; =&gt; &quot;81920&quot;
}
</pre></div>
</td></tr></table>

<h3 id="95es">9.5、查看ES中的内容<a class="headerlink" href="#95es" title="Permanent link">&para;</a></h3>
<p>通过elasticsearch-head插件查看ES中是否收到了由logstash发送过来的日志：</p>
<p>在浏览器中打开<code>http://192.168.1.1:9100</code></p>
<p><img alt="elasticsearch-head" src="../../../img/elasticsearch-head.png" /></p>
<h3 id="96kibanaes">9.6、kibana连接ES<a class="headerlink" href="#96kibanaes" title="Permanent link">&para;</a></h3>
<h4 id="961index-pattern">9.6.1、创建index-pattern<a class="headerlink" href="#961index-pattern" title="Permanent link">&para;</a></h4>
<p>(1)、打开<code>http://192.168.1.5:5601</code>进入首页后，点击“connect to your Elasticsearch index”</p>
<p><img alt="kibana-index1" src="../../../img/kibana-index1.png" /></p>
<p>(2)、点击“Create index pattern”</p>
<p><img alt="kibana-index2" src="../../../img/kibana-index2.png" /></p>
<p>(3)、填入elasticsearch中的索引名，支持正则匹配：</p>
<p><img alt="kibana-index3" src="../../../img/kibana-index3.png" /></p>
<p>(4)、这一步要选择用来作时间过滤的字段</p>
<p><img alt="kibana-index4" src="../../../img/kibana-index4.png" /></p>
<p>(5)、选择“@timestamp”作为时间过滤字段，然后点击“create index pattern”：</p>
<p><img alt="kibana-index5" src="../../../img/kibana-index5.png" /></p>
<p>(6)、创建完成后：</p>
<p><img alt="kibana-index6" src="../../../img/kibana-index6.png" /></p>
<h4 id="962">9.6.2、查看日志<a class="headerlink" href="#962" title="Permanent link">&para;</a></h4>
<p>(1)、右上角选择要查看的时间范围</p>
<p><img alt="kibana-index7" src="../../../img/kibana-index7.png" /></p>
<p>(2)、选择“Today”后，可以看到有数据显示出来了</p>
<p><img alt="kibana-index8" src="../../../img/kibana-index8.png" /></p>
<p><strong>至此，本次测试过程就结束了，有关每个部分的详细配置，之后会有文档单独介绍。</strong></p>
<p>s</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../dstor数据接口定义/" title="Dstor数据访问接口定义" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Dstor数据访问接口定义
              </span>
            </div>
          </a>
        
        
          <a href="../linux里面以指定用户运行命令/" title="linux里面以指定用户运行命令" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                linux里面以指定用户运行命令
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.583bbe55.js"></script>
      
      <script>app.initialize({version:"1.0.1",url:{base:"../../.."}})</script>
      
    
    
      
    
  </body>
</html>